---
title: "IPSec 테스트 설정"
date: 2025-11-11
tags:
  - "ChatGPT"
url: "https://chatgpt.com/c/69131bad-89a4-8322-a8ad-b5e6a5ece38c"
projectName: ""
---

## You

두대의 Linux PC에서 사전에 합의된 인증/암호화 키(0x22222222222222222222222222222222)/알고리즘(인증 hmac(md5), 암호화 cbc(aes))으로 IPSec으로 packet으로 ping 통신 가능한 양쪽(192.168.0.10 / 192.168.0.1) 모두 맞춘 완전한 세트로 정리된 테스트 설정 값을 만들어주세요.

---

## ChatGPT

좋아요. 아래는 **두 대의 Linux PC(192.168.0.10 ↔ 192.168.0.1)** 사이를 **ESP/transport 모드**, **인증: hmac(md5)**, **암호화: cbc(aes)**, **키: `0x22222222222222222222222222222222`(128비트)** 로 설정해서 `ping` 이 암호화되어 통신되도록 하는 **완전한 테스트 세트**입니다.  
(IPsec을 수동 키잉 `ip xfrm`으로 구성합니다. strongSwan/libreswan 불필요)

---

# 1) 공통 전제
- 각 PC의 IP
  - PC-A: `192.168.0.10`
  - PC-B: `192.168.0.1`
- 알고리즘: `auth hmac(md5)` / `enc cbc(aes)`
- 키(양방향 동일 키 사용, 테스트 목적):  
  `0x22222222222222222222222222222222` (16바이트 = 128비트)
- SPI 값(충돌 방지용 예시):
  - A→B : `0x100`
  - B→A : `0x200`

> 참고: 일부 보안 정책(FIPS 모드)에서는 MD5가 비활성화될 수 있습니다. 테스트용으로는 문제없지만, `/proc/sys/crypto/fips_enabled` 가 `1`이면 MD5 사용이 막힐 수 있습니다.

---

# 2) PC-A(192.168.0.10) 설정 스크립트

`setup_a.sh`
```bash
#!/usr/bin/env bash
set -e

# 커널 모듈 (대부분 자동 로드되지만 안전하게)
sudo modprobe xfrm_user
sudo modprobe esp4

# 초기화
sudo ip xfrm state flush
sudo ip xfrm policy flush

A=192.168.0.10
B=192.168.0.1
AUTH_KEY=0x22222222222222222222222222222222   # 128-bit
ENC_KEY=0x22222222222222222222222222222222    # 128-bit

# --- SA(A->B, outbound) ---
sudo ip xfrm state add src $A dst $B proto esp spi 0x100 mode transport \
  auth hmac(md5) $AUTH_KEY 128 \
  enc  cbc(aes)  $ENC_KEY

# --- SA(B->A, inbound) ---
sudo ip xfrm state add src $B dst $A proto esp spi 0x200 mode transport \
  auth hmac(md5) $AUTH_KEY 128 \
  enc  cbc(aes)  $ENC_KEY

# 정책(트래픽 선택자: 호스트-호스트)
sudo ip xfrm policy add dir out  src $A/32 dst $B/32 tmpl src $A dst $B proto esp mode transport
sudo ip xfrm policy add dir in   src $B/32 dst $A/32 tmpl src $B dst $A proto esp mode transport

# 검증 출력
echo "=== xfrm state ==="
sudo ip xfrm state
echo "=== xfrm policy ==="
sudo ip xfrm policy
echo "PC-A 설정 완료"
```

`cleanup_a.sh`
```bash
#!/usr/bin/env bash
set -e
sudo ip xfrm state flush
sudo ip xfrm policy flush
echo "PC-A IPsec 구성 초기화 완료"
```

---

# 3) PC-B(192.168.0.1) 설정 스크립트

`setup_b.sh`
```bash
#!/usr/bin/env bash
set -e

sudo modprobe xfrm_user
sudo modprobe esp4

sudo ip xfrm state flush
sudo ip xfrm policy flush

A=192.168.0.10
B=192.168.0.1
AUTH_KEY=0x22222222222222222222222222222222
ENC_KEY=0x22222222222222222222222222222222

# --- SA(B->A, outbound) ---
sudo ip xfrm state add src $B dst $A proto esp spi 0x200 mode transport \
  auth hmac(md5) $AUTH_KEY 128 \
  enc  cbc(aes)  $ENC_KEY

# --- SA(A->B, inbound) ---
sudo ip xfrm state add src $A dst $B proto esp spi 0x100 mode transport \
  auth hmac(md5) $AUTH_KEY 128 \
  enc  cbc(aes)  $ENC_KEY

# 정책
sudo ip xfrm policy add dir out  src $B/32 dst $A/32 tmpl src $B dst $A proto esp mode transport
sudo ip xfrm policy add dir in   src $A/32 dst $B/32 tmpl src $A dst $B proto esp mode transport

echo "=== xfrm state ==="
sudo ip xfrm state
echo "=== xfrm policy ==="
sudo ip xfrm policy
echo "PC-B 설정 완료"
```

`cleanup_b.sh`
```bash
#!/usr/bin/env bash
set -e
sudo ip xfrm state flush
sudo ip xfrm policy flush
echo "PC-B IPsec 구성 초기화 완료"
```

---

# 4) 적용/테스트 절차

1) 두 PC 각각에서 실행 권한 부여
```bash
chmod +x setup_a.sh cleanup_a.sh
chmod +x setup_b.sh cleanup_b.sh
```

2) **PC-A**에서 `./setup_a.sh`, **PC-B**에서 `./setup_b.sh` 실행

3) **핑 테스트**  
- A에서 B로:
  ```bash
  ping -c 3 192.168.0.1
  ```
- B에서 A로:
  ```bash
  ping -c 3 192.168.0.10
  ```

4) **패킷이 ESP로 암호화됐는지 확인**
- A 혹은 B에서:
  ```bash
  sudo tcpdump -ni <인터페이스> proto 50
  ```
  `IP` 대신 `ESP`로 표시되는 트래픽이 보이면 정상.

5) **상태/정책 확인**
```bash
ip xfrm state
ip xfrm policy
```

---

# 5) 문제 발생 시 체크 포인트
- **라우팅/ARP**: 두 호스트가 L2로 서로 도달 가능한지(같은 서브넷, 스위치/방화벽 규칙) 확인.
- **SPI/키/알고리즘 불일치**: 두 PC의 `spi`·알고리즘·키가 **방향별로 정확히 대응**해야 합니다(위 스크립트는 맞춰져 있음).
- **FIPS 모드**: `/proc/sys/crypto/fips_enabled` 가 `1`이면 `hmac(md5)`가 거부될 수 있습니다.
- **중복 정책**: 과거 설정이 남아 있으면 충돌할 수 있으므로 `state/policy flush`로 초기화 후 다시 적용.

---

원하시면 위 구성을 **tunnel 모드(예: 10.0.0.0/24 ↔ 10.0.1.0/24)** 로 바꾸거나, **알고리즘/SPI/키를 분리(방향별 다른 키)** 하는 보안 강화 버전도 바로 만들어 드릴게요.